---
title: "Thesis Validation Overview"
author: "Arsalan Anwari"
date: "2023-06-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Data preparation

## 1.1 Load libraries
```{r load_libs, warning=FALSE, include=FALSE}

library(tidyverse)
library(sf)
library(gridExtra) # to create nxn facets for ggplot

library(conflicted)
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")


```

## 1.2 Load data
```{r load_data}

sf_oberservations_train <- readRDS("Data/knmi_windspeed_observations_training_set.rds")
sf_observations_anual <- readRDS("Data/knmi_windspeed_complete_set.rds")

ls_training_results <- readRDS("Data/dynamic_training_routine_training_results_annual_avg.rds")
ls_training_settings <- readRDS("Data/dynamic_training_routine_training_settings_annual_avg.rds")

```

## 1.3 Prepare data of training set

```{r prepare_data}

sf_oberservations_train <- sf_oberservations_train %>%
    mutate(
      x = st_coordinates(.)[,1],
      y = st_coordinates(.)[,2]
    )

df_training_results.trend_surface <- ls_training_results$trend_surface
df_training_results.mqrbf <- ls_training_results$mqrbf
df_training_results.idw <- ls_training_results$idw
df_training_results.od_kriging <- ls_training_results$od_kriging
df_training_results.u_kriging <- ls_training_results$u_kriging

```

```{r show_data}

head(df_training_results.trend_surface)
head(df_training_results.mqrbf)
head(df_training_results.idw)
head(df_training_results.od_kriging)
head(df_training_results.u_kriging)

```

```{r prepare_model_opts}

model_opt.trend_surface <- c("model = linear", "model = hyperbolic")
model_opt.mqrbf <- sprintf("smoothing factor = %f", ls_training_settings$mqrbf_smoothing_factor)
model_opt.idw <- sprintf("neighbors = %d", ls_training_settings$neighbor_range)
model_opt.od_kriging <- sprintf("neighbors = %d", ls_training_settings$neighbor_range)
model_opt.u_kriging <- c(
  sprintf("neighbors = %d, model = %s", 5, "linear"),
  sprintf("neighbors = %d, model = %s", 5, "hyperbolic"),
  sprintf("neighbors = %d, model = %s", 6, "linear"),
  sprintf("neighbors = %d, model = %s", 6, "hyperbolic"),
  sprintf("neighbors = %d, model = %s", 7, "linear"),
  sprintf("neighbors = %d, model = %s", 7, "hyperbolic")
)

```

```{r modify_training_results}

df_training_results.trend_surface <- df_training_results.trend_surface %>%
  rename(model_opt_id = model_opt, old_rmse = old_rsme, new_rmse = new_rsme) %>%
  mutate(
    model_opt_id = as.integer(model_opt_id),
    model_opt_name = model_opt.trend_surface[model_opt_id],
    train_iteration = as.integer(train_iteration),
    old_rmse = as.double(old_rmse),
    new_rmse = as.double(new_rmse),
    loss_value = as.double(loss_value),
    case_weight = as.double(weights)
  ) %>%
  select( model_opt_id, model_opt_name, train_iteration, case_weight, old_rmse, new_rmse, loss_value )

df_training_results.mqrbf <- df_training_results.mqrbf %>%
  rename(model_opt_id = model_opt, old_rmse = old_rsme, new_rmse = new_rsme) %>%
  mutate(
    model_opt_id = as.integer(model_opt_id),
    model_opt_name = model_opt.mqrbf[model_opt_id],
    train_iteration = as.integer(train_iteration),
    old_rmse = as.double(old_rmse),
    new_rmse = as.double(new_rmse),
    loss_value = as.double(loss_value),
    alpha_weight = as.double(weights)
  ) %>%
  select( model_opt_id, model_opt_name, train_iteration, alpha_weight, old_rmse, new_rmse, loss_value )

df_training_results.idw <- df_training_results.idw %>%
  rename(model_opt_id = model_opt, old_rmse = old_rsme, new_rmse = new_rsme) %>%
  mutate(
    model_opt_id = as.integer(model_opt_id),
    model_opt_name = model_opt.idw[model_opt_id],
    train_iteration = as.integer(train_iteration),
    old_rmse = as.double(old_rmse),
    new_rmse = as.double(new_rmse),
    loss_value = as.double(loss_value),
    idp = as.double(weights)
  ) %>%
  select( model_opt_id, model_opt_name, train_iteration, idp, old_rmse, new_rmse, loss_value )

df_training_results.od_kriging <- df_training_results.od_kriging %>%
  rename(model_opt_id = model_opt, old_rmse = old_rsme, new_rmse = new_rsme) %>%
  mutate(
    model_opt_id = as.integer(model_opt_id),
    model_opt_name = model_opt.od_kriging[model_opt_id],
    train_iteration = as.integer(train_iteration),
    old_rmse = as.double(old_rmse),
    new_rmse = as.double(new_rmse),
    loss_value = as.double(loss_value),
    weights = strsplit(weights, ",")
  ) %>%
  unnest_wider(weights, names_sep = "_") %>%
  mutate( 
    psill = as.double(weights_2), 
    range = as.double(weights_3) 
  ) %>%
  select( model_opt_id, model_opt_name, train_iteration, psill, range, old_rmse, new_rmse, loss_value )

df_training_results.u_kriging <- df_training_results.u_kriging %>%
  rename(model_opt_id = model_opt, old_rmse = old_rsme, new_rmse = new_rsme) %>%
  mutate(
    model_opt_id = as.integer(model_opt_id),
    model_opt_name = model_opt.u_kriging[model_opt_id],
    train_iteration = as.integer(train_iteration),
    old_rmse = as.double(old_rmse),
    new_rmse = as.double(new_rmse),
    loss_value = as.double(loss_value),
    weights = strsplit(weights, ",")
  ) %>%
  unnest_wider(weights, names_sep = "_") %>%
  mutate( 
    psill = as.double(weights_2), 
    range = as.double(weights_3) 
  ) %>%
  select( model_opt_id, model_opt_name, train_iteration, psill, range, old_rmse, new_rmse, loss_value )

```


```{r show_modify_training_results}

head(df_training_results.trend_surface)
head(df_training_results.mqrbf)
head(df_training_results.idw)
head(df_training_results.od_kriging)
head(df_training_results.u_kriging)

```

```{r andskjasndk}

df_training_results.u_kriging

```


# 2. Analyse RMSE results of training set

## 2.1 Find weights with lowest RMSE per model variation for training set 

```{r find_lowest_rmse_per_variation}

find_lowest_rmse_per_model_opt <- function(df){
  df_grouped_rmse <- df %>%
    group_by(model_opt_id) %>%
    summarise(old_rmse = min(old_rmse))

  df_found <- df %>%
    filter(new_rmse %in% df_grouped_rmse$old_rmse) %>%
    rename(rmse = new_rmse) %>%
    select(!c(model_opt_id, train_iteration, loss_value, old_rmse))
  
  if (nrow(df_found) == 0){
    df_found <- df %>%
      filter(old_rmse %in% df_grouped_rmse$old_rmse) %>%
      rename(rmse = old_rmse) %>%
      select(!c(model_opt_id, train_iteration, loss_value, new_rmse))
  }
  
  return(df_found)
}

```


```{r get_lowest_rmse_per_variation}

df_lowest_rmse_per_opt.trend_surface <- find_lowest_rmse_per_model_opt(df_training_results.trend_surface)
df_lowest_rmse_per_opt.mqrbf <- find_lowest_rmse_per_model_opt(df_training_results.mqrbf)
df_lowest_rmse_per_opt.idw <- find_lowest_rmse_per_model_opt(df_training_results.idw)
df_lowest_rmse_per_opt.od_kriging <- find_lowest_rmse_per_model_opt(df_training_results.od_kriging)
df_lowest_rmse_per_opt.u_kriging <- find_lowest_rmse_per_model_opt(df_training_results.u_kriging)

```

```{r show_lowest_rmse_per_variation}

df_lowest_rmse_per_opt.trend_surface
df_lowest_rmse_per_opt.mqrbf
df_lowest_rmse_per_opt.idw
df_lowest_rmse_per_opt.od_kriging
df_lowest_rmse_per_opt.u_kriging

```

## 2.2 Save results of combination of weight and variation with lowest RMSE per model

```{r find_lowest_rmse_combo}

save.weights_with_lowest_rmse_per_opt <- list(
  trend_surface = df_lowest_rmse_per_opt.trend_surface,
  mqrbf = df_lowest_rmse_per_opt.mqrbf,
  idw = df_lowest_rmse_per_opt.idw,
  od_kriging = df_lowest_rmse_per_opt.od_kriging,
  u_kriging = df_lowest_rmse_per_opt.u_kriging
)

saveRDS(save.weights_with_lowest_rmse_per_opt, "Data/weights_with_lowest_rmse_per_opt.rds")

```

## 2.3 Show fluctuations of new weights and its effect on RMSE

- Measurements of the IDW model where chosen as they showed the highest amount of fluctuation per model variation

```{r prepare_fluctuation_measurements_idw}

df_idw_training_flucts <- df_training_results.idw %>%
  select(model_opt_id, train_iteration, idp, new_rmse) %>%
  mutate(
    neighbors = ls_training_settings$neighbor_range[model_opt_id],
    neighbors = as.character(neighbors)
    ) %>%
  rename(rmse = new_rmse)

df_idw_training_flucts

summary(df_idw_training_flucts$rmse)

```

```{r plot_fluctuation_measurements_idw}

plot_train_results <- df_idw_training_flucts %>% 
  ggplot( aes(x = train_iteration, y = rmse, fill = neighbors, linetype = factor(neighbors)) ) +
  geom_line(position = "identity", linewidth = 0.5) +
  scale_fill_grey(start = 0.1, end = 0.9) +
  labs(title = "Training results (IDW)", linetype = "neighbors") +
  theme_bw() +
  theme(legend.position = "bottom", legend.direction = "horizontal")

plot_weight_effect <- df_idw_training_flucts %>% 
  ggplot( aes(x = train_iteration, y = idp, fill = neighbors, linetype = factor(neighbors)) ) +
  geom_line(position = "identity", linewidth = 0.5) +
  scale_y_continuous(position = "right") +
  scale_fill_grey(start = 0.1, end = 0.9) +
  labs(title = "IDP weights (IDW)", linetype = "neighbors") +
  theme_bw() + 
  theme(legend.position = "bottom", legend.direction = "horizontal")


grid.arrange(plot_train_results, plot_weight_effect, ncol = 2)


```

# 3. Analyse spatial interpolation metrics

## 3.1 Prepare dataset for different metrics

### 3.1.1 Seasonal set
```{r define_season_set_days}

season_set_days.spring <- as.Date(c(
  "2017-03-01", "2017-03-08", "2017-03-15", "2017-03-22",
  "2017-04-01", "2017-04-08", "2017-04-15", "2017-04-22",
  "2017-05-01", "2017-05-08", "2017-05-15", "2017-05-22"
))

season_set_days.summer <- as.Date(c(
  "2017-06-01", "2017-06-08", "2017-06-15", "2017-06-22",
  "2017-07-01", "2017-07-08", "2017-07-15", "2017-07-22",
  "2017-08-01", "2017-08-08", "2017-08-15", "2017-08-22"
))

season_set_days.autumn <- as.Date(c(
  "2017-09-01", "2017-09-08", "2017-09-15", "2017-09-22",
  "2017-10-01", "2017-10-08", "2017-10-15", "2017-10-22",
  "2017-11-01", "2017-11-08", "2017-11-15", "2017-11-22"
))

season_set_days.winter <- as.Date(c(
  "2017-12-01", "2017-12-08", "2017-12-15", "2017-12-22",
  "2017-01-01", "2017-01-08", "2017-01-15", "2017-01-22",
  "2017-02-01", "2017-02-08", "2017-02-15", "2017-02-22"
))

```

```{r create_seasonal_set}

sf_seasonal_set.spring <- sf_observations_anual %>%
  filter( date %in% season_set_days.spring )

sf_seasonal_set.summer <- sf_observations_anual %>%
  filter( date %in% season_set_days.summer )

sf_seasonal_set.autumn <- sf_observations_anual %>%
  filter( date %in% season_set_days.autumn )

sf_seasonal_set.winter <- sf_observations_anual %>%
  filter( date %in% season_set_days.winter )

```

### 3.1.2 Annual set

```{r define_annual_set_days}

gen_annuals_set_days <- function(){
  start_date <- as.Date("2017-01-01")
  out <- rep(NA, times = 48)

  i <- 1
  for(m in 0:11){
    for(d in 1:4){
      new_date <- start_date + months(m) + days(d)
      out[i] <- format(new_date, "%Y-%m-%d")
      i <- i + 1
    }
  }

  return(as.Date(out))
}

annual_set_days <- gen_annuals_set_days()

print(annual_set_days)

```

```{r create_annual_set}

sf_annual_set <- sf_observations_anual %>%
  filter( date %in% annual_set_days )

```

### 3.1.3 Random set

```{r define_random_set_days}

gen_random_set_days <- function(){
  set.seed(242534327)
  
  start_date <- as.Date("2017-01-01")
  out <- rep(NA, times = 48)

  for(i in 1:48){
    rand_day <- as.integer(runif(1, min=0, max=28))
    rand_month <- as.integer(runif(1, min=0, max=11))
    new_date <- start_date + months(rand_month) + days(rand_day)
    out[i] <- format(new_date, "%Y-%m-%d")
  }

  return(as.Date(out))
}

random_set_days <- gen_annuals_set_days()
print(random_set_days)

```

```{r create_random_set}

sf_random_set <- sf_observations_anual %>%
  filter( date %in% random_set_days )

```

### 3.1.4 Clustered set

```{r create_sample_map}

sf_sample_map <- sf_observations_anual %>%
  filter( date == as.Date("2017-01-01") )

sf_sample_map

```

```{r plot_sample_map}

sf_sample_map %>%
  ggplot() +
    geom_sf(alpha = 0.0) +
    geom_sf_text(aes(label = station_code), size = 3) +
    theme_void()

```
As you can see from the plot, the following stations are in or near the province of Zeeland:
	- 312, 316, 324, 331, 340, 315, 310, 313, 308, 319, 330, 343
	
```{r define_clustered_set_days}

gen_clustered_set_days <- function(){
  set.seed(35433)
  
  start_date <- as.Date("2017-01-01")
  out <- rep(NA, times = 48)

  for(i in 1:48){
    rand_day <- as.integer(runif(1, min=0, max=28))
    rand_month <- as.integer(runif(1, min=0, max=11))
    new_date <- start_date + months(rand_month) + days(rand_day)
    
    out[i] <- format(new_date, "%Y-%m-%d")
  }

  return(as.Date(out))
}

clustered_set_days <- gen_clustered_set_days()
print(clustered_set_days)

```
	
```{r create_clustered_set}

clustered_set_stations <- c(312, 316, 324, 331, 340, 315, 310, 313, 308, 319, 330, 343)

sf_clustered_set <- sf_observations_anual %>%
  filter( date %in% clustered_set_days & station_code %in% clustered_set_stations )

```
	
### 3.1.5 Sparse set

Based on the map shown in 3.1.4 the following stations where selected from the center and north of the Netherlands for the sparse set
- Center: 260, 269, 275, 375, 215, 240
- North: 270, 280, 279, 273, 267, 242

The stations 260 and 270 can be seen as the center point where de distance between them and the other points is maximized.
	
```{r create_sparse_set}

sparse_set_stations <- c(260, 269, 275, 375, 215, 240, 270, 280, 279, 273, 267, 242)

sf_sparse_set <- sf_observations_anual %>%
  filter( date %in% clustered_set_days & station_code %in% sparse_set_stations )

```


### 3.1.6 Check if sets have correct sizes	
	
```{r compare_set_sizes}

station_count <- length(unique(sf_observations_anual$station_code))
all_season_set_size <- (
  length(unique(sf_seasonal_set.spring$date)) +
  length(unique(sf_seasonal_set.summer$date)) + 
  length(unique(sf_seasonal_set.autumn$date)) + 
  length(unique(sf_seasonal_set.winter$date))
)

cat(sprintf(
  "
  Anual set days = %d
  Seasonal set days = %d
    Seasonal days [spring] = %d
    Seasonal days [summer] = %d
    Seasonal days [autumn] = %d
    Seasonal days [winter] = %d
  Random set days = %d
  Clustered set days = %d
  Sparse set days = %d
  ",
  length(unique(sf_annual_set$date)), 
  all_season_set_size,
    length(unique(sf_seasonal_set.spring$date)),
    length(unique(sf_seasonal_set.summer$date)),
    length(unique(sf_seasonal_set.autumn$date)),
    length(unique(sf_seasonal_set.winter$date)),
  length(unique(sf_random_set$date)),
  length(unique(sf_clustered_set$date)),
  length(unique(sf_sparse_set$date))
))


```
